note *
note * This build script is in an extended Make Abstract Machine (MAM)
note * language. Documentation is at: src/cmd/INIT/README-mamake.md
note *

setv MAMAKE_STRICT 3
setv INSTALLROOT ../../..
setv CC cc
setv AR ${mam_cc_AR} ${mam_cc_AR_ARFLAGS}
setv mam_cc_FLAGS ${mam_cc_TARGET} ${mam_cc_DLL} ${mam_cc_PIC} ${-debug-symbols?1?${mam_cc_DEBUG} -D_BLD_DEBUG?${mam_cc_OPTIMIZE}?}
setv CCFLAGS
setv IFFEFLAGS
setv LDFLAGS

make install virtual
	note *
	note * Library dependencies
	note *

	bind -last
	make sum.req
		prev ${INSTALLROOT}/bin/mkreq
		exec - mkreq ${CC} ${mam_cc_FLAGS} ${CCFLAGS} ${mam_cc_NOSTRICTALIASING} : ${LDFLAGS} : sum md ast
	done

	note *
	note * Build the library
	note *

	make libsum.a
		make sumlib.o
			make sumlib.c
				make sum-sha2.c implicit
					prev ${INCLUDE_AST}/endian.h
				done
				prev sum-sha1.c implicit
				prev sum-md5.c implicit
				prev sum-lmd.c implicit
				make sum-prng.c implicit
					prev ${INCLUDE_AST}/fnv.h
				done
				prev sum-bsd.c implicit
				prev sum-ast4.c implicit
				make FEATURE/sum implicit
					prev features/sum
					exec - iffe ${IFFEFLAGS} -v -c \
					exec -  '${CC} ${mam_cc_FLAGS} ${CCFLAGS} ${mam_cc_NOSTRICTALIASING} ${LDFLAGS}' \
					exec -	ref ${mam_cc_L+-L${INSTALLROOT}/lib} -I${INCLUDE_AST} \
					exec -	-I${INSTALLROOT}/include ${mam_libast} : run ${<}
				done
				prev ${INCLUDE_AST}/hashpart.h
				prev ${INCLUDE_AST}/swap.h
				prev ${INCLUDE_AST}/endian.h
				make sum.h implicit
					prev ${INCLUDE_AST}/ast.h
				done
				make sum-att.c implicit
					prev ${INCLUDE_AST}/ast.h
				done
				make sum-crc.c implicit
					prev ${INCLUDE_AST}/ast.h
				done
			done
			exec - ${CC} ${mam_cc_FLAGS} ${CCFLAGS} ${mam_cc_NOSTRICTALIASING} -I. -I${INCLUDE_AST} -c ${<}
		done sumlib.o
		exec - ${AR} rc ${@} ${<} || exit
		exec - ranlib ${@} >/dev/null 2>&1 || true
	done libsum.a

	note *
	note * pre-install
	note *

	loop DIR ${INSTALLROOT}/lib/lib ${INCLUDE_AST}
		make ${DIR}
			exec - mkdir -p ${@}
		done
	done
	make ${INSTALLROOT}/lib/libsum.a
		prev libsum.a
		exec - cp -f ${<} ${@} || exit
		exec - ranlib ${@} >/dev/null 2>&1 || true
	done
	make ${INSTALLROOT}/lib/lib/sum
		prev sum.req
		exec - cp -f ${<} ${@}
	done
	note * public headers
	make ${INSTALLROOT}/lib/mam/sum
		make ${INCLUDE_AST}/sum.h
			prev sum.h
			exec - cp -f ${<} ${@}
		done
		note * generate header dependency rules
		exec - mkdeps -lsum -last ${^} > ${@}
		prev ${INSTALLROOT}/bin/mkdeps
		prev sum.req
	done ${INSTALLROOT}/lib/mam/sum
done install

make test dontcare virtual
done test
